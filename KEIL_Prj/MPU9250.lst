C51 COMPILER V8.05a   MPU9250                                                              07/14/2017 09:19:27 PAGE 1   


C51 COMPILER V8.05a, COMPILATION OF MODULE MPU9250
OBJECT MODULE PLACED IN .\MPU9250.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\HARDWARE\DEVICES\SENSOR\MPU9250\MPU9250.C LARGE BROWSE DEBUG OBJECTEX
                    -TEND PRINT(.\MPU9250.lst) TABS(2) OBJECT(.\MPU9250.obj)

line level    source

   1          #include "MPU9250.H"
   2          typedef struct{
   3            short Accel[3];//Accel X,Y,Z
   4            short Gyro[3];//Gyro X,Y,Z
   5            short Mag[3]; //Mag X,Y,Z 
   6          }MPU_value;
   7          MPU_value mpu_value;          //9轴数据
   8          unsigned char BUF[6];       //接收数据缓存区
   9          void spi_Init()
  10          {
  11   1        
  12   1      }
  13          
  14          /***************************************************************/
  15          //SPI发送
  16          //reg: addr
  17          //value:数据
  18          /***************************************************************/
  19          u8 MPU9250_Write_Reg(u8 reg,u8 value)
  20          {
  21   1        u8 status;
  22   1          MPU_9250_ENABLE;   // MPU9250_CS=0;  //片选MPU9250
  23   1        status=SPI1_ReadWriteByte(reg); //发送reg地址
  24   1        SPI1_ReadWriteByte(value);//发送数据
  25   1        MPU_9250_DISENABLE;// MPU9250_CS=1;  //失能MPU9250
  26   1        return(status);//
  27   1      }
  28          //---------------------------------------------------------------//
  29          //SPI读取
  30          //reg: addr
  31          u8 MPU9250_Read_Reg(u8 reg)
  32          {
  33   1          u8 reg_val;
  34   1          MPU_9250_ENABLE;//  MPU9250_CS=0;  //片选MPU9250
  35   1          SPI1_ReadWriteByte(reg|0x80); //reg地址+读命令
  36   1          reg_val=SPI1_ReadWriteByte(0xff);//任意数据
  37   1          MPU_9250_DISENABLE;// MPU9250_CS=1;  //失能MPU9250
  38   1        return(reg_val);
  39   1      }
  40          //****************初始化MPU9250，根据需要请参考pdf进行修改************************
  41          void Init_MPU9250(void)
  42          { 
  43   1        MPU9250_Write_Reg(PWR_MGMT_1, 0x00);  //解除休眠状态
  44   1        MPU9250_Write_Reg(CONFIG, 0x07);      //低通滤波频率，典型值：0x07(3600Hz)此寄存器内决定Internal_Sample_R
             -ate==8K
  45   1        
  46   1      /**********************Init SLV0 i2c**********************************/ 
  47   1      //Use SPI-bus read slave0
  48   1        MPU9250_Write_Reg(INT_PIN_CFG ,0x30);// INT Pin / Bypass Enable Configuration  
  49   1        MPU9250_Write_Reg(I2C_MST_CTRL,0x4d);//I2C MAster mode and Speed 400 kHz
  50   1        MPU9250_Write_Reg(USER_CTRL ,0x20); // I2C_MST _EN 
  51   1        MPU9250_Write_Reg(I2C_MST_DELAY_CTRL ,0x01);//延时使能I2C_SLV0 _DLY_ enable   
  52   1        MPU9250_Write_Reg(I2C_SLV0_CTRL ,0x81); //enable IIC  and EXT_SENS_DATA==1 Byte
  53   1        
C51 COMPILER V8.05a   MPU9250                                                              07/14/2017 09:19:27 PAGE 2   

  54   1      /*******************Init GYRO and ACCEL******************************/  
  55   1        MPU9250_Write_Reg(SMPLRT_DIV, 0x07);  //陀螺仪采样率，典型值：0x07(1kHz) (SAMPLE_RATE= Internal_Sample_Ra
             -te / (1 + SMPLRT_DIV) )
  56   1        MPU9250_Write_Reg(GYRO_CONFIG, 0x18); //陀螺仪自检及测量范围，典型值：0x18(不自检，2000deg/s)
  57   1        MPU9250_Write_Reg(ACCEL_CONFIG, 0x18);//加速计自检、测量范围及高通滤波频率，典型值：0x18(不自检，16G)
  58   1        MPU9250_Write_Reg(ACCEL_CONFIG_2, 0x08);//加速计高通滤波频率 典型值 ：0x08  （1.13kHz） 
  59   1          
  60   1      /**********************Init MAG **********************************/
  61   1        i2c_Mag_write(AK8963_CNTL2_REG,AK8963_CNTL2_SRST); // Reset AK8963
  62   1        i2c_Mag_write(AK8963_CNTL1_REG,0x12); // use i2c to set AK8963 working on Continuous measurement mode1 & 
             -16-bit output  
  63   1      }
  64          
  65          //************************加速度读取**************************/
  66          void READ_MPU9250_ACCEL(void)//
  67          { 
  68   1      
  69   1         BUF[0]=MPU9250_Read_Reg(ACCEL_XOUT_L); 
  70   1         BUF[1]=MPU9250_Read_Reg(ACCEL_XOUT_H);
  71   1         mpu_value.Accel[0]=  (BUF[1]<<8)|BUF[0];
  72   1         mpu_value.Accel[0]/=164;                //读取计算X轴数据
  73   1         BUF[2]=MPU9250_Read_Reg(ACCEL_YOUT_L);
  74   1         BUF[3]=MPU9250_Read_Reg(ACCEL_YOUT_H);
  75   1         mpu_value.Accel[1]=  (BUF[3]<<8)|BUF[2];
  76   1         mpu_value.Accel[1]/=164;                //读取计算Y轴数据
  77   1         BUF[4]=MPU9250_Read_Reg(ACCEL_ZOUT_L); 
  78   1         BUF[5]=MPU9250_Read_Reg(ACCEL_ZOUT_H);
  79   1         mpu_value.Accel[2]=  (BUF[5]<<8)|BUF[4];
  80   1         mpu_value.Accel[2]/=164;                 //读取计算Z轴数据 
  81   1      }
  82          /**********************陀螺仪读取*****************************/
  83          void READ_MPU9250_GYRO(void)
  84          { 
  85   1      
  86   1         BUF[0]=MPU9250_Read_Reg(GYRO_XOUT_L); 
  87   1         BUF[1]=MPU9250_Read_Reg(GYRO_XOUT_H);
  88   1         mpu_value.Gyro[0]= (BUF[1]<<8)|BUF[0];
  89   1         mpu_value.Gyro[0]/=16.4;                //读取计算X轴数据
  90   1      
  91   1         BUF[2]=MPU9250_Read_Reg(GYRO_YOUT_L);
  92   1         BUF[3]=MPU9250_Read_Reg(GYRO_YOUT_H);
  93   1         mpu_value.Gyro[1]= (BUF[3]<<8)|BUF[2];
  94   1         mpu_value.Gyro[1]/=16.4;                //读取计算Y轴数据
  95   1         BUF[4]=MPU9250_Read_Reg(GYRO_ZOUT_L);
  96   1         BUF[5]=MPU9250_Read_Reg(GYRO_ZOUT_H);
  97   1         mpu_value.Gyro[2]= (BUF[5]<<8)|BUF[4];
  98   1         mpu_value.Gyro[2]/=16.4;                  //读取计算Z轴数据
  99   1      }
 100          
 101          
 102          /**********************磁力计读取***************************/
 103          //i2c_Mag_read(AK8963_ST2_REG) 此步读取不可省略
 104          //数据读取结束寄存器，reading this register means data reading end
 105          //AK8963_ST2_REG 同时具有数据非正常溢出检测功能
 106          //详情参考 MPU9250 PDF
 107          /**********************************************************/
 108          void READ_MPU9250_MAG(void)
 109          {   
 110   1        u8 x_axis,y_axis,z_axis; 
 111   1        
 112   1        x_axis=i2c_Mag_read(AK8963_ASAX);// X轴灵敏度调整值
 113   1        y_axis=i2c_Mag_read(AK8963_ASAY);
C51 COMPILER V8.05a   MPU9250                                                              07/14/2017 09:19:27 PAGE 3   

 114   1        z_axis=i2c_Mag_read(AK8963_ASAZ);
 115   1        
 116   1        if((i2c_Mag_read(AK8963_ST1_REG)&AK8963_ST1_DOR)==0)//data ready
 117   1        {
 118   2            //读取计算X轴数据
 119   2           BUF[0]=i2c_Mag_read(MAG_XOUT_L); //Low data  
 120   2           if((i2c_Mag_read(AK8963_ST2_REG)&AK8963_ST2_HOFL)==1)// data reading end register & check Magnetic sens
             -or overflow occurred 
 121   2           {
 122   3             BUF[0]=i2c_Mag_read(MAG_XOUT_L);//reload data
 123   3           } 
 124   2           BUF[1]=i2c_Mag_read(MAG_XOUT_H); //High data 
 125   2           if((i2c_Mag_read(AK8963_ST2_REG)&AK8963_ST2_HOFL)==1)// data reading end register
 126   2           {
 127   3             BUF[1]=i2c_Mag_read(MAG_XOUT_H);
 128   3           }
 129   2           mpu_value.Mag[0]=((BUF[1]<<8)|BUF[0])*(((x_axis-128)>>8)+1);   //灵敏度纠正 公式见/RM-MPU-9250A-00 PDF/ 
             -5.13  
 130   2           
 131   2          //读取计算Y轴数据
 132   2            BUF[2]=i2c_Mag_read(MAG_YOUT_L); //Low data 
 133   2           if((i2c_Mag_read(AK8963_ST2_REG)&AK8963_ST2_HOFL)==1)// data reading end register
 134   2           {
 135   3             BUF[2]=i2c_Mag_read(MAG_YOUT_L);
 136   3           }     
 137   2           BUF[3]=i2c_Mag_read(MAG_YOUT_H); //High data 
 138   2           if((i2c_Mag_read(AK8963_ST2_REG)&AK8963_ST2_HOFL)==1)// data reading end register
 139   2           {
 140   3             BUF[3]=i2c_Mag_read(MAG_YOUT_H);
 141   3           }
 142   2            mpu_value.Mag[1]=((BUF[3]<<8)|BUF[2])*(((y_axis-128)>>8)+1);  
 143   2           
 144   2          //读取计算Z轴数据
 145   2           BUF[4]=i2c_Mag_read(MAG_ZOUT_L); //Low data  
 146   2           if((i2c_Mag_read(AK8963_ST2_REG)&AK8963_ST2_HOFL)==1)// data reading end register
 147   2           {
 148   3             BUF[4]=i2c_Mag_read(MAG_ZOUT_L);
 149   3           }   
 150   2           BUF[5]=i2c_Mag_read(MAG_ZOUT_H); //High data 
 151   2           if((i2c_Mag_read(AK8963_ST2_REG)&AK8963_ST2_HOFL)==1)// data reading end register
 152   2           {
 153   3             BUF[5]=i2c_Mag_read(MAG_ZOUT_H);
 154   3           }
 155   2            mpu_value.Mag[2]=((BUF[5]<<8)|BUF[4])*(((z_axis-128)>>8)+1);  
 156   2        }                
 157   1      }
 158          
 159          
 160          
 161          
 162          /***************************************************************/
 163          //SPIx 
 164          //TxData:发送一个字节
 165          //返回值:data
 166          /***************************************************************/
 167          static u8 SPI1_ReadWriteByte(u8 TxData)
 168          {   
 169   1      //  u8 retry=0;         
 170   1      //  while (SPI_I2S_GetFlagStatus(SPI1, SPI_I2S_FLAG_TXE) == RESET) //等待SPI发送标志位空
 171   1      //    {
 172   1      //    retry++;
 173   1      //    if(retry>200)return 0;
C51 COMPILER V8.05a   MPU9250                                                              07/14/2017 09:19:27 PAGE 4   

 174   1      //    }       
 175   1      //  SPI_I2S_SendData(SPI1, TxData); //发送数据
 176   1      //  retry=0;
 177   1      
 178   1      //  while (SPI_I2S_GetFlagStatus(SPI1, SPI_I2S_FLAG_RXNE) == RESET) //等待SPI接收标志位空
 179   1      //    {
 180   1      //    retry++;
 181   1      //    if(retry>200)return 0;
 182   1      //    }                   
 183   1      //  return SPI_I2S_ReceiveData(SPI1); //接收数据              
 184   1      }
*** WARNING C173 IN LINE 184 OF ..\HARDWARE\DEVICES\SENSOR\MPU9250\MPU9250.C: missing return-expression
*** WARNING C280 IN LINE 167 OF ..\HARDWARE\DEVICES\SENSOR\MPU9250\MPU9250.C: 'TxData': unreferenced local variable
 185          /***************************************************************/
 186          // MPU内部i2c 读取
 187          //I2C_SLVx_ADDR:  MPU9250_AK8963_ADDR
 188          //I2C_SLVx_REG:   reg
 189          //return value:   EXT_SENS_DATA_00 register value
 190          /***************************************************************/
 191          static u8 i2c_Mag_read(u8 reg)
 192          {
 193   1        u16 j=5000;
 194   1        MPU9250_Write_Reg(I2C_SLV0_ADDR ,MPU9250_AK8963_ADDR|0x80); //设置磁力计地址，mode：read
 195   1        MPU9250_Write_Reg(I2C_SLV0_REG ,reg);// set reg addr
 196   1        MPU9250_Write_Reg(I2C_SLV0_DO ,0xff);//read
 197   1        while(j--);//此处因为MPU内部I2C读取速度较慢，必须延时等待内部读取完毕
 198   1        return MPU9250_Read_Reg(EXT_SENS_DATA_00);
 199   1      }
 200          
 201          /***************************************************************/
 202          // MPU内部i2c 写入
 203          //I2C_SLVx_ADDR:  MPU9250_AK8963_ADDR
 204          //I2C_SLVx_REG:   reg
 205          //I2C_SLVx_Data out:  value
 206          /***************************************************************/
 207          static void i2c_Mag_write(u8 reg,u8 value)
 208          {
 209   1        u16 j=500;
 210   1        MPU9250_Write_Reg(I2C_SLV0_ADDR ,MPU9250_AK8963_ADDR);//设置磁力计地址,mode: write
 211   1        MPU9250_Write_Reg(I2C_SLV0_REG ,reg);//set reg addr
 212   1        MPU9250_Write_Reg(I2C_SLV0_DO ,value);//send value  
 213   1        while(j--);//此处因为MPU内部I2C读取速度较慢，延时等待内部写完毕
 214   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    905    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     24      13
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
